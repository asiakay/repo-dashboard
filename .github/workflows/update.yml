name: Initialize & Update Repo Dashboard

# Needed so GitHub Actions can commit files to the repo
permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  init-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # ============================================================
      # 1. FIRST-RUN DETECTOR
      # ============================================================
      - name: Check if project has been initialized
        id: check_init
        run: |
          if [ -f ".project_initialized" ]; then
            echo "initialized=true" >> $GITHUB_OUTPUT
          else
            echo "initialized=false" >> $GITHUB_OUTPUT
          fi

      # ============================================================
      # 2. INITIALIZE FOLDERS ON FIRST RUN ONLY
      # ============================================================
      - name: Create folder structure
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          mkdir -p public/data
          mkdir -p public/js
          mkdir -p public/components
          mkdir -p public/icons
          mkdir -p public/assets
          mkdir -p worker
          mkdir -p scripts
          mkdir -p tests
          mkdir -p docs

      - name: Create placeholder files
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          echo "<!-- Repo Dashboard -->" > public/index.html
          echo "/* styles */" > public/styles.css
          echo "{}" > public/data/repos.json
          echo "// Worker entrypoint" > worker/worker.js
          echo "// Process repos" > scripts/process-repos.js
          echo "// Worker test" > tests/worker.test.js
          echo "# Architecture" > docs/architecture.md
          echo "// JS placeholder" > public/js/app.js

      # ============================================================
      # 3. FORCE-STAGE ALL INITIALIZATION FILES
      # ============================================================
      - name: Force stage initialization files
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          git add public
          git add worker
          git add scripts
          git add tests
          git add docs
          echo "Initialized $(date)" > .project_initialized
          git add .project_initialized

      # ============================================================
      # 4. FETCH GITHUB REPO DATA
      # ============================================================
      - name: Fetch GitHub repositories
        run: |
          mkdir -p public
          curl -s -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/users/asiakay/repos?per_page=200" \
               -o public/raw.json

      # ============================================================
      # 4a. DEBUG — SHOW EXACT API RESPONSE
      # ============================================================
      - name: Debug raw GitHub response
        run: |
          echo "==== RAW JSON FROM GITHUB API ===="
          cat public/raw.json
          echo "=================================="

      # ============================================================
      # 5. PROCESS raw.json → repos.json (with safety checks)
      # ============================================================
      - name: Convert raw.json → repos.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          const raw = JSON.parse(fs.readFileSync('public/raw.json'));

          // If GitHub returned an error instead of an array
          if (!Array.isArray(raw)) {
            console.error("GitHub API error:", raw);
            fs.writeFileSync('public/data/repos.json', JSON.stringify({
              error: true,
              message: "GitHub API returned an error",
              github_response: raw,
              timestamp: new Date()
            }, null, 2));
            process.exit(0);
          }

          function health(repo) {
            let score = 0;
            const days = (Date.now() - new Date(repo.updated_at)) / 86400000;
            if (days > 30) score++;
            if (days > 180) score += 2;
            if (repo.open_issues_count > 5) score++;
            if (!repo.description) score++;
            return score < 2 ? "green" : score < 4 ? "yellow" : "red";
          }

          const cleaned = raw.map(r => ({
            name: r.name,
            full_name: r.full_name,
            url: r.html_url,
            description: r.description,
            updated_at: r.updated_at,
            language: r.language,
            open_issues: r.open_issues_count,
            health: health(r)
          }));

          fs.writeFileSync(
            'public/data/repos.json',
            JSON.stringify(cleaned, null, 2)
          );
          EOF

      # ============================================================
      # 6. AUTO-COMMIT any changes (init OR updates)
      # ============================================================
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Initialize structure + update repos.json"
          file_pattern: |
            .project_initialized
            public/**
            worker/**
            scripts/**
            tests/**
            docs/**
