name: Initialize & Update Repo Dashboard

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  init-and-update:
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # CORE CHECKOUT + NODE
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # <-- IMPORTANT: allows committing new files

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # ============================================================
      # 1. FIRST-RUN DETECTOR
      # ============================================================
      - name: Check if project has been initialized
        id: check_init
        run: |
          if [ -f ".project_initialized" ]; then
            echo "initialized=true" >> $GITHUB_OUTPUT
          else
            echo "initialized=false" >> $GITHUB_OUTPUT
          fi

      # ============================================================
      # 2. INITIALIZE FOLDERS ON FIRST RUN ONLY
      # ============================================================
      - name: Create folder structure
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          mkdir -p public/data
          mkdir -p public/js
          mkdir -p public/components
          mkdir -p public/icons
          mkdir -p public/assets
          mkdir -p worker
          mkdir -p scripts
          mkdir -p tests
          mkdir -p docs

      - name: Create placeholder files
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          echo "<!-- Repo Dashboard -->" > public/index.html
          echo "/* styles */" > public/styles.css
          echo "{}" > public/data/repos.json
          echo "// Worker entrypoint" > worker/worker.js
          echo "// Process repos" > scripts/process-repos.js
          echo "// Worker test" > tests/worker.test.js
          echo "# Architecture" > docs/architecture.md
          echo "// JS placeholder" > public/js/app.js

      # ============================================================
      # 2b. CREATE CLOUDFLARE PAGES + FUNCTIONS STRUCTURE
      # ============================================================
      - name: Create Pages + Functions directories
        run: |
          mkdir -p functions/api

      - name: Generate Cloudflare Functions endpoint (api/repos)
        run: |
          cat << 'EOF' > functions/api/repos.js
          export async function onRequest(context) {
            const repos = await fetch(
              "https://raw.githubusercontent.com/${{ github.repository }}/main/public/data/repos.json"
            ).then(r => r.json());

            return new Response(JSON.stringify({
              count: repos.length,
              repos
            }), {
              headers: {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*"
              }
            });
          }
          EOF

      - name: Generate wrangler.jsonc
        run: |
          cat << 'EOF' > wrangler.jsonc
          {
            "name": "repo-dashboard",
            "compatibility_date": "2025-11-19",
            "pages_build_output_dir": "./public",
            "functions": {
              "directory": "./functions"
            }
          }
          EOF

      # ============================================================
      # 3. FORCE-STAGE INITIALIZATION FILES
      # ============================================================
      - name: Force stage initialization files
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          git add -A
          echo "Initialized $(date)" > .project_initialized
          git add .project_initialized

      # ============================================================
      # 4. DEBUG FILESYSTEM BEFORE CURL
      # ============================================================
      - name: Debug filesystem before curl
        run: |
          echo "------ Checking directories before curl ------"
          ls -R .
          echo "------------------------------------------------"

      # ============================================================
      # 4. FETCH GITHUB REPO DATA (DEBUG MODE)
      # ============================================================
      - name: Fetch ALL GitHub repositories (pagination)
        run: |
          mkdir -p public
          PAGE=1
          > public/raw.json  # truncate file

          echo "[" >> public/raw.json

          while true; do
            echo "Fetching page $PAGE..."

            RESP=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/asiakay/repos?per_page=100&page=$PAGE")

            COUNT=$(echo "$RESP" | jq 'length')

            # stop if empty page
            if [ "$COUNT" -eq 0 ]; then
              break
            fi

            # add comma only between pages
            if [ "$PAGE" -gt 1 ]; then
              echo "," >> public/raw.json
            fi

            echo "$RESP" >> public/raw.json
            PAGE=$((PAGE+1))
          done

          echo "]" >> public/raw.json


      # ============================================================
      # 4a. DEBUG RAW JSON (ONLY IF FILE EXISTS)
      # ============================================================
      - name: Debug raw GitHub response
        run: |
          if [ -f public/raw.json ]; then
            echo "============ RAW JSON FROM GITHUB API ============"
            head -n 30 public/raw.json
            echo "==================================================="
          else
            echo "❌ raw.json not found — skipping debug"
          fi

      # ============================================================
      # 4b. ENSURE OUTPUT FOLDER EXISTS
      # ============================================================
      - name: Ensure public/data exists
        run: mkdir -p public/data

      # ============================================================
      # 5. PROCESS raw.json → repos.json
      # ============================================================
      - name: Convert raw.json → repos.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          if (!fs.existsSync('public/raw.json')) {
            console.error("❌ raw.json not found — cannot proceed.");
            process.exit(1);
          }

          const raw = JSON.parse(fs.readFileSync('public/raw.json'));

          if (!Array.isArray(raw)) {
            console.error("GitHub API error:", raw);
            fs.writeFileSync('public/data/repos.json', JSON.stringify({
              error: true,
              message: "GitHub API returned an error",
              github_response: raw,
              timestamp: new Date()
            }, null, 2));
            process.exit(0);
          }

          function health(repo) {
            let score = 0;
            const days = (Date.now() - new Date(repo.updated_at)) / 86400000;
            if (days > 30) score++;
            if (days > 180) score += 2;
            if (repo.open_issues_count > 5) score++;
            if (!repo.description) score++;
            return score < 2 ? "green" : score < 4 ? "yellow" : "red";
          }

          const cleaned = raw.map(r => ({
            name: r.name,
            full_name: r.full_name,
            url: r.html_url,
            description: r.description,
            updated_at: r.updated_at,
            language: r.language,
            open_issues: r.open_issues_count,
            health: health(r)
          }));

          fs.writeFileSync(
            'public/data/repos.json',
            JSON.stringify(cleaned, null, 2)
          );

          console.log("Wrote repos.json with", cleaned.length, "repos.");
          EOF

      # ============================================================
      # 6. AUTO-COMMIT ANY CHANGES
      # ============================================================
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update repo data"
          add_options: "-A"   # <-- IMPORTANT: commits ALL new + modified files
