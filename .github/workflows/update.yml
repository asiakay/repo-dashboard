name: Initialize & Update Repo Dashboard

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  init-and-update:
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # CORE CHECKOUT + NODE
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # <-- IMPORTANT: allows committing new files

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # ============================================================
      # 1. FIRST-RUN DETECTOR
      # ============================================================
      - name: Check if project has been initialized
        id: check_init
        run: |
          if [ -f ".project_initialized" ]; then
            echo "initialized=true" >> $GITHUB_OUTPUT
          else
            echo "initialized=false" >> $GITHUB_OUTPUT
          fi

      # ============================================================
      # 2. INITIALIZE FOLDERS ON FIRST RUN ONLY
      # ============================================================
      - name: Create folder structure
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          mkdir -p public/data
          mkdir -p public/js
          mkdir -p public/components
          mkdir -p public/icons
          mkdir -p public/assets
          mkdir -p worker
          mkdir -p scripts
          mkdir -p tests
          mkdir -p docs

      - name: Create placeholder files
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          echo "<!-- Repo Dashboard -->" > public/index.html
          echo "/* styles */" > public/styles.css
          echo "{}" > public/data/repos.json
          echo "// Worker entrypoint" > worker/worker.js
          echo "// Process repos" > scripts/process-repos.js
          echo "// Worker test" > tests/worker.test.js
          echo "# Architecture" > docs/architecture.md
          echo "// JS placeholder" > public/js/app.js

      # ============================================================
      # 3. FORCE-STAGE INITIALIZATION FILES
      # ============================================================
      - name: Force stage initialization files
        if: steps.check_init.outputs.initialized == 'false'
        run: |
          git add -A
          echo "Initialized $(date)" > .project_initialized
          git add .project_initialized

      # ============================================================
      # 4. DEBUG FILESYSTEM BEFORE CURL
      # ============================================================
      - name: Debug filesystem before curl
        run: |
          echo "------ Checking directories before curl ------"
          ls -R .
          echo "------------------------------------------------"

      # ============================================================
      # 4. FETCH GITHUB REPO DATA (DEBUG MODE)
      # ============================================================
      - name: Fetch GitHub repositories (debug mode)
        run: |
          mkdir -p public

          echo "------ Curling with diagnostics ------"

          curl -v \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/asiakay/repos?per_page=200" \
            -o public/raw.json

          echo "------ Checking exit code ------"
          echo $?

          echo "------ Listing public/ after curl ------"
          ls -l public

          echo "------ If file exists, show first 20 lines ------"
          if [ -f public/raw.json ]; then
            head -n 20 public/raw.json
          else
            echo "❌ raw.json does NOT exist"
          fi

      # ============================================================
      # 4a. DEBUG RAW JSON (ONLY IF FILE EXISTS)
      # ============================================================
      - name: Debug raw GitHub response
        run: |
          if [ -f public/raw.json ]; then
            echo "============ RAW JSON FROM GITHUB API ============"
            head -n 30 public/raw.json
            echo "==================================================="
          else
            echo "❌ raw.json not found — skipping debug"
          fi

      # ============================================================
      # 4b. ENSURE OUTPUT FOLDER EXISTS
      # ============================================================
      - name: Ensure public/data exists
        run: mkdir -p public/data

      # ============================================================
      # 5. PROCESS raw.json → repos.json
      # ============================================================
      - name: Convert raw.json → repos.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          if (!fs.existsSync('public/raw.json')) {
            console.error("❌ raw.json not found — cannot proceed.");
            process.exit(1);
          }

          const raw = JSON.parse(fs.readFileSync('public/raw.json'));

          if (!Array.isArray(raw)) {
            console.error("GitHub API error:", raw);
            fs.writeFileSync('public/data/repos.json', JSON.stringify({
              error: true,
              message: "GitHub API returned an error",
              github_response: raw,
              timestamp: new Date()
            }, null, 2));
            process.exit(0);
          }

          function health(repo) {
            let score = 0;
            const days = (Date.now() - new Date(repo.updated_at)) / 86400000;
            if (days > 30) score++;
            if (days > 180) score += 2;
            if (repo.open_issues_count > 5) score++;
            if (!repo.description) score++;
            return score < 2 ? "green" : score < 4 ? "yellow" : "red";
          }

          const cleaned = raw.map(r => ({
            name: r.name,
            full_name: r.full_name,
            url: r.html_url,
            description: r.description,
            updated_at: r.updated_at,
            language: r.language,
            open_issues: r.open_issues_count,
            health: health(r)
          }));

          fs.writeFileSync(
            'public/data/repos.json',
            JSON.stringify(cleaned, null, 2)
          );

          console.log("Wrote repos.json with", cleaned.length, "repos.");
          EOF

      # ============================================================
      # 6. AUTO-COMMIT ANY CHANGES
      # ============================================================
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update repo data"
          add_options: "-A"   # <-- IMPORTANT: commits ALL new + modified files
